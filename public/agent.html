<!DOCTYPE html>
<html>
<head>
	<meta charset="UTF-8" />
	<title>Agent Stream</title>
</head>
<body>
	<h3>Agent - sending screen stream</h3>
	<video id="preview" autoplay muted style="width: 400px;"></video>
	<script src="https://cdn.socket.io/4.3.2/socket.io.min.js"></script>
	<script>
		const socket = io.connect('/', { transports: ['websocket'] });
		const roomId = 'dlp-room';
		let pc;

		socket.emit('join-room', roomId);

		socket.on('user-joined', (id) => {
			console.log('Viewer joined:', id);
			startStream();
		});

		async function startStream() {
			const screenStream = await navigator.mediaDevices.getDisplayMedia({ video: true });
			document.getElementById('preview').srcObject = screenStream;

			pc = new RTCPeerConnection({
				iceServers: [{ urls: 'stun:stun.l.google.com:19302' }],
			});

			screenStream.getTracks().forEach(track => pc.addTrack(track, screenStream));

			pc.onicecandidate = e => {
				if (e.candidate) {
					socket.emit('ice-candidate', { roomId, candidate: e.candidate });
				}
			};

			const offer = await pc.createOffer();
			await pc.setLocalDescription(offer);
			socket.emit('offer', { roomId, sdp: offer });
		}

		socket.on('answer', async ({ sdp }) => {
			await pc.setRemoteDescription(new RTCSessionDescription(sdp));
		});

		socket.on('ice-candidate', async ({ candidate }) => {
			try {
				await pc.addIceCandidate(candidate);
			} catch (e) {
				console.error(e);
			}
		});
	</script>
</body>
</html>
