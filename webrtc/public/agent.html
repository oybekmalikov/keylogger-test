<!-- <!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Agent</title>
  </head>
  <body>
    <h1>Agent â€” Screen stream</h1>
    <button id="startBtn">Start streaming</button>
    <video id="preview" autoplay muted playsinline></video>

    <script src="/socket.io/socket.io.js"></script>
    <script>
      const socket = io();
      const peer = new RTCPeerConnection();

      peer.onicecandidate = (e) => {
        if (e.candidate) socket.emit("candidate", e.candidate);
      };

      socket.on("answer", async (answer) => {
        await peer.setRemoteDescription(answer);
        console.log("Answer received");
      });

      socket.on("candidate", async (candidate) => {
        await peer.addIceCandidate(candidate);
      });

      document.getElementById("startBtn").addEventListener("click", async () => {
        try {
          console.log("Requesting screen capture...");
          const stream = await navigator.mediaDevices.getDisplayMedia({
            video: true,
            audio: false,
          });

          document.getElementById("preview").srcObject = stream;

          // Track qoâ€˜shish
          stream.getTracks().forEach((track) => peer.addTrack(track, stream));

          // Offer yaratish
          const offer = await peer.createOffer();
          await peer.setLocalDescription(offer);
          socket.emit("offer", offer);
          console.log("Offer sent");
        } catch (err) {
          console.error("Screen capture error:", err);
        }
      });
    </script>
  </body>
</html> -->
<!-- 
<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Agent</title>
  </head>
  <body>
    <h1>Agent â€” Screen + Webcam stream</h1>
    <button id="startBtn">Start streaming</button>

    <div style="display: flex; gap: 20px;">
      <div>
        <h3>Screen Preview</h3>
        <video id="screenPreview" autoplay muted playsinline width="400"></video>
      </div>
      <div>
        <h3>Camera Preview</h3>
        <video id="camPreview" autoplay muted playsinline width="400"></video>
      </div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
      const socket = io();
      const peer = new RTCPeerConnection();

      peer.onicecandidate = (e) => {
        if (e.candidate) socket.emit("candidate", e.candidate);
      };

      socket.on("answer", async (answer) => {
        await peer.setRemoteDescription(answer);
        console.log("Answer received");
      });

      socket.on("candidate", async (candidate) => {
        await peer.addIceCandidate(candidate);
      });

      document.getElementById("startBtn").addEventListener("click", async () => {
        try {
          console.log("Capturing screen and camera...");

          // ðŸ–¥ Screen stream
          const screenStream = await navigator.mediaDevices.getDisplayMedia({
            video: true,
          });
          document.getElementById("screenPreview").srcObject = screenStream;

          // ðŸŽ¥ Camera stream
          const camStream = await navigator.mediaDevices.getUserMedia({
            video: true,
            audio: false,
          });
          document.getElementById("camPreview").srcObject = camStream;

          // ðŸ”— Ikkala streamdagi barcha tracklarni qoâ€˜shamiz
          [...screenStream.getTracks(), ...camStream.getTracks()].forEach((track) =>
            peer.addTrack(track, screenStream)
          );

          // Offer yaratamiz
          const offer = await peer.createOffer();
          await peer.setLocalDescription(offer);
          socket.emit("offer", offer);
          console.log("Offer sent (screen + camera)");
        } catch (err) {
          console.error("Stream error:", err);
        }
      });
    </script>
  </body>
</html>
 -->
<!-- 
 <!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Agent</title>
  </head>
  <body>
    <h1>Agent â€” Screen + Webcam stream</h1>
    <button id="startBtn">Start streaming</button>

    <div style="display: flex; gap: 20px;">
      <div>
        <h3>Screen Preview</h3>
        <video id="screenPreview" autoplay muted playsinline width="400"></video>
      </div>
      <div>
        <h3>Camera Preview</h3>
        <video id="camPreview" autoplay muted playsinline width="400"></video>
      </div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
      const socket = io();
      const peer = new RTCPeerConnection();

      peer.onicecandidate = (e) => {
        if (e.candidate) socket.emit("candidate", e.candidate);
      };

      socket.on("answer", async (answer) => {
        await peer.setRemoteDescription(answer);
      });

      socket.on("candidate", async (candidate) => {
        await peer.addIceCandidate(candidate);
      });

      document.getElementById("startBtn").addEventListener("click", async () => {
        try {
         const screenStream = await navigator.mediaDevices.getDisplayMedia({ video: true });
          document.getElementById("screenPreview").srcObject = screenStream;
          const camStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: false });
          document.getElementById("camPreview").srcObject = camStream;

          screenStream.getTracks().forEach(track => peer.addTrack(track, screenStream));
          camStream.getTracks().forEach(track => peer.addTrack(track, camStream));

          const offer = await peer.createOffer();
          await peer.setLocalDescription(offer);
          socket.emit("offer", offer);
        } catch (err) {
          console.error("Stream error:", err);
        }
      });
    </script>
  </body>
</html> -->

<!-- 
  <!DOCTYPE html>
  <html>
    <head>
      <meta charset="utf-8" />
      <title>Agent</title>
    </head>
    <body>
      <h1>Agent â€” Screen + Webcam Stream</h1>
      <button id="startBtn">Start Streaming</button>
      <div style="display: flex; gap: 20px; margin-top: 20px;">
        <div>
          <h3>Screen Preview</h3>
          <video id="screenPreview" autoplay muted playsinline width="400"></video>
        </div>
        <div>
          <h3>Camera Preview</h3>
          <video id="camPreview" autoplay muted playsinline width="400"></video>
        </div>
      </div>
      <script src="/socket.io/socket.io.js"></script>
      <script>
        const socket = io();
        const peer = new RTCPeerConnection({
          iceServers: [
            { urls: "stun:stun.l.google.com:19302" },
            {
              urls: "turn:openrelay.metered.ca:80",
              username: "openrelayproject",
              credential: "openrelayproject",
            },
          ],
        });
        peer.onicecandidate = (e) => {
          if (e.candidate) socket.emit("candidate", e.candidate);
        };
        socket.on("answer", async (answer) => {
          await peer.setRemoteDescription(answer);
        });
        socket.on("candidate", async (candidate) => {
          await peer.addIceCandidate(candidate);
        });
        document.getElementById("startBtn").addEventListener("click", async () => {
          try {
            const screenStream = await navigator.mediaDevices.getDisplayMedia({ video: true });
            document.getElementById("screenPreview").srcObject = screenStream;
            const camStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: false });
            document.getElementById("camPreview").srcObject = camStream;
            screenStream.getTracks().forEach((track) => peer.addTrack(track, screenStream));
            camStream.getTracks().forEach((track) => peer.addTrack(track, camStream));
            const offer = await peer.createOffer();
            await peer.setLocalDescription(offer);
            socket.emit("offer", offer);
          } catch (err) {
            console.error("Stream error:", err);
          }
        });
      </script>
    </body>
  </html> -->

<!-- <!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Agent</title>
  <style>
    .status {
      padding: 10px;
      margin: 10px 0;
      border-radius: 5px;
    }
    .online {
      background: #4CAF50;
      color: white;
    }
    .offline {
      background: #f44336;
      color: white;
    }
  </style>
</head>
<body>
  <h1>Agent â€” Screen + Webcam Stream</h1>
  <div class="status" id="status">Initializing...</div>
  <button id="startBtn">Start Streaming</button>
  <button id="stopBtn" disabled>Stop Streaming</button>
  <div style="display: flex; gap: 20px; margin-top: 20px;">
    <div>
      <h3>Screen Preview</h3>
      <video id="screenPreview" autoplay muted playsinline width="400"></video>
    </div>
    <div>
      <h3>Camera Preview</h3>
      <video id="camPreview" autoplay muted playsinline width="400"></video>
    </div>
  </div>
  <script src="/socket.io/socket.io.js"></script>
  <script>
    const socket = io()
    const peers = new Map()
    let screenStream = null
    let camStream = null
    let isStreaming = false
    const statusDiv = document.getElementById("status")
    const startBtn = document.getElementById("startBtn")
    const stopBtn = document.getElementById("stopBtn")
    function updateStatus(message, isOnline) {
      statusDiv.textContent = message
      statusDiv.className = `status ${isOnline ? 'online' : 'offline'}`
    }
    socket.on("connect", () => {
      console.log("Connected to server")
      socket.emit("register-agent")
      updateStatus("Connected - Waiting for streams...", true)
    })
    socket.on("disconnect", () => {
      updateStatus("Disconnected from server", false)
    })
    socket.on("admin-joined", async (adminId) => {
      console.log("Admin joined:", adminId)
      if (!isStreaming) return
      const peer = createPeerConnection(adminId)
      peers.set(adminId, peer)
      screenStream.getTracks().forEach((track) => peer.addTrack(track, screenStream))
      camStream.getTracks().forEach((track) => peer.addTrack(track, camStream))
      try {
        const offer = await peer.createOffer()
        await peer.setLocalDescription(offer)
        socket.emit("offer", { offer, to: adminId })
      } catch (err) {
        console.error("Error creating offer:", err)
      }
    })
    socket.on("answer", async (data) => {
      console.log("Answer received from:", data.from)
      const peer = peers.get(data.from)
      if (peer) {
        try {
          await peer.setRemoteDescription(data.answer)
        } catch (err) {
          console.error("Error setting remote description:", err)
        }
      }
    })
    socket.on("candidate", async (data) => {
      const peer = peers.get(data.from)
      if (peer && data.candidate) {
        try {
          await peer.addIceCandidate(data.candidate)
        } catch (err) {
          console.error("Error adding ICE candidate:", err)
        }
      }
    })
    function createPeerConnection(adminId) {
      const peer = new RTCPeerConnection({
        iceServers: [
          { urls: "stun:stun.l.google.com:19302" },
          { urls: "stun:stun1.l.google.com:19302" },
          {
            urls: "turn:openrelay.metered.ca:80",
            username: "openrelayproject",
            credential: "openrelayproject",
          },
        ],
        iceCandidatePoolSize: 10
      })
      peer.onicecandidate = (e) => {
        if (e.candidate) {
          socket.emit("candidate", {
            candidate: e.candidate,
            to: adminId
          })
        }
      }
      peer.onconnectionstatechange = () => {
        console.log(`Peer connection state (${adminId}):`, peer.connectionState)
        if (peer.connectionState === "failed" || peer.connectionState === "disconnected") {
          peers.delete(adminId)
        }
      }
      return peer
    }
    startBtn.addEventListener("click", async () => {
      try {
        updateStatus("Starting streams...", true)
        screenStream = await navigator.mediaDevices.getDisplayMedia({
          video: { width: 1920, height: 1080 }
        })
        document.getElementById("screenPreview").srcObject = screenStream
        camStream = await navigator.mediaDevices.getUserMedia({
          video: { width: 1280, height: 720 },
          audio: false
        })
        document.getElementById("camPreview").srcObject = camStream
        isStreaming = true
        startBtn.disabled = true
        stopBtn.disabled = false
        updateStatus("Streaming - Ready for admin connections", true)
        screenStream.getVideoTracks()[0].onended = () => {
          stopStreaming()
        }
      } catch (err) {
        console.error("Stream error:", err)
        updateStatus(`Error: ${err.message}`, false)
        stopStreaming()
      }
    })
    stopBtn.addEventListener("click", stopStreaming)
    function stopStreaming() {
      isStreaming = false
      if (screenStream) {
        screenStream.getTracks().forEach(track => track.stop())
        screenStream = null
      }
      if (camStream) {
        camStream.getTracks().forEach(track => track.stop())
        camStream = null
      }
      peers.forEach(peer => peer.close())
      peers.clear()
      document.getElementById("screenPreview").srcObject = null
      document.getElementById("camPreview").srcObject = null
      startBtn.disabled = false
      stopBtn.disabled = true
      updateStatus("Streams stopped", false)
    }
  </script>
</body>

</html> -->

<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8" />
<title>Agent</title>
<style>
  .status { padding: 10px; margin: 10px 0; border-radius: 5px; }
  .online { background: #4CAF50; color: white; }
  .offline { background: #f44336; color: white; }
</style>
</head>
<body>
<h1>Agent â€” Screen + Webcam Stream</h1>
<div class="status" id="status">Initializing...</div>
<button id="startBtn">Start Streaming</button>
<button id="stopBtn" disabled>Stop Streaming</button>
<div style="display: flex; gap: 20px; margin-top: 20px;">
  <div>
    <h3>Screen Preview</h3>
    <video id="screenPreview" autoplay muted playsinline width="400"></video>
  </div>
  <div>
    <h3>Camera Preview</h3>
    <video id="camPreview" autoplay muted playsinline width="400"></video>
  </div>
</div>
<script src="/socket.io/socket.io.js"></script>
<script>
const socket = io();
const peers = new Map(); // Multiple admin connections
let screenStream = null;
let camStream = null;
let isStreaming = false;

const statusDiv = document.getElementById("status");
const startBtn = document.getElementById("startBtn");
const stopBtn = document.getElementById("stopBtn");

function updateStatus(message, isOnline) {
  statusDiv.textContent = message;
  statusDiv.className = `status ${isOnline ? 'online' : 'offline'}`;
}

// Register as agent when connected
socket.on("connect", () => {
  console.log("Connected to server");
  socket.emit("register-agent");
  updateStatus("Connected - Waiting for streams...", true);
});

socket.on("disconnect", () => {
  updateStatus("Disconnected from server", false);
});

// When admin joins, create a new peer connection
socket.on("admin-joined", async (adminId) => {
  console.log("Admin joined:", adminId);
  
  if (!isStreaming) return;
  
  // Create peer for this admin
  const peer = createPeerConnection(adminId);
  peers.set(adminId, peer);
  
  // Add tracks
  screenStream.getTracks().forEach((track) => peer.addTrack(track, screenStream));
  camStream.getTracks().forEach((track) => peer.addTrack(track, camStream));
  
  // Create and send offer
  try {
    const offer = await peer.createOffer();
    await peer.setLocalDescription(offer);
    socket.emit("offer", { offer, to: adminId });
  } catch (err) {
    console.error("Error creating offer:", err);
  }
});

// Handle answer from admin
socket.on("answer", async (data) => {
  console.log("Answer received from:", data.from);
  const peer = peers.get(data.from);
  if (peer) {
    try {
      await peer.setRemoteDescription(data.answer);
    } catch (err) {
      console.error("Error setting remote description:", err);
    }
  }
});

// Handle ICE candidates
socket.on("candidate", async (data) => {
  const peer = peers.get(data.from);
  if (peer && data.candidate) {
    try {
      await peer.addIceCandidate(data.candidate);
    } catch (err) {
      console.error("Error adding ICE candidate:", err);
    }
  }
});

function createPeerConnection(adminId) {
  const peer = new RTCPeerConnection({
    iceServers: [
      { urls: "stun:stun.l.google.com:19302" },
      { urls: "stun:stun1.l.google.com:19302" },
      {
        urls: "turn:openrelay.metered.ca:80",
        username: "openrelayproject",
        credential: "openrelayproject",
      },
    ],
    iceCandidatePoolSize: 10
  });

  peer.onicecandidate = (e) => {
    if (e.candidate) {
      socket.emit("candidate", {
        candidate: e.candidate,
        to: adminId
      });
    }
  };

  peer.onconnectionstatechange = () => {
    console.log(`Peer connection state (${adminId}):`, peer.connectionState);
    if (peer.connectionState === "failed" || peer.connectionState === "disconnected") {
      peers.delete(adminId);
    }
  };

  return peer;
}

startBtn.addEventListener("click", async () => {
  try {
    updateStatus("Starting streams...", true);
    
    // Get screen stream
    screenStream = await navigator.mediaDevices.getDisplayMedia({ 
      video: { width: 1920, height: 1080 }
    });
    document.getElementById("screenPreview").srcObject = screenStream;
    
    // Get camera stream
    camStream = await navigator.mediaDevices.getUserMedia({ 
      video: { width: 1280, height: 720 }, 
      audio: false 
    });
    document.getElementById("camPreview").srcObject = camStream;
    
    isStreaming = true;
    startBtn.disabled = true;
    stopBtn.disabled = false;
    
    updateStatus("Streaming - Ready for admin connections", true);
    
    // Handle stream end (user stopped sharing)
    screenStream.getVideoTracks()[0].onended = () => {
      stopStreaming();
    };
    
  } catch (err) {
    console.error("Stream error:", err);
    updateStatus(`Error: ${err.message}`, false);
    stopStreaming();
  }
});

stopBtn.addEventListener("click", stopStreaming);

function stopStreaming() {
  isStreaming = false;
  
  // Stop all tracks
  if (screenStream) {
    screenStream.getTracks().forEach(track => track.stop());
    screenStream = null;
  }
  if (camStream) {
    camStream.getTracks().forEach(track => track.stop());
    camStream = null;
  }
  
  // Close all peer connections
  peers.forEach(peer => peer.close());
  peers.clear();
  
  // Clear video elements
  document.getElementById("screenPreview").srcObject = null;
  document.getElementById("camPreview").srcObject = null;
  
  startBtn.disabled = false;
  stopBtn.disabled = true;
  updateStatus("Streams stopped", false);
}
</script>
</body>
</html>